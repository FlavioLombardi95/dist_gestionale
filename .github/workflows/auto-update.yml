name: ğŸ”„ Auto Update System

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  auto-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Check Files Consistency
      run: |
        echo "ğŸ” Verificando coerenza file..."
        
        # Controlla se requirements.txt Ã¨ aggiornato
        if [ -f "requirements.txt" ]; then
          echo "âœ… requirements.txt trovato"
          pip freeze > current_reqs.txt
          # Verifica dipendenze principali
          grep -q "Flask" requirements.txt && echo "âœ… Flask presente" || echo "âŒ Flask mancante"
          grep -q "SQLAlchemy" requirements.txt && echo "âœ… SQLAlchemy presente" || echo "âŒ SQLAlchemy mancante"
        fi
        
        # Controlla struttura file
        [ -f "app.py" ] && echo "âœ… app.py presente" || echo "âŒ app.py mancante"
        [ -f "Procfile" ] && echo "âœ… Procfile presente" || echo "âŒ Procfile mancante"
        [ -d "templates" ] && echo "âœ… templates/ presente" || echo "âŒ templates/ mancante"
        [ -d "static" ] && echo "âœ… static/ presente" || echo "âŒ static/ mancante"
        
    - name: ğŸ“Š Generate Stats
      run: |
        echo "ğŸ“Š Generando statistiche progetto..."
        
        # Conta righe codice
        LINES_APP=$(wc -l < app.py)
        LINES_HTML=$(find templates -name "*.html" -exec wc -l {} + | tail -1 | awk '{print $1}')
        TOTAL_FILES=$(find . -type f -name "*.py" -o -name "*.html" -o -name "*.js" -o -name "*.css" | wc -l)
        
        echo "ğŸ”¢ Statistiche:"
        echo "- Righe app.py: $LINES_APP"
        echo "- Righe templates: $LINES_HTML"  
        echo "- File totali: $TOTAL_FILES"
        
        # Salva statistiche in file
        echo "# ğŸ“Š Statistiche Progetto" > STATS.md
        echo "" >> STATS.md
        echo "- **Righe codice principale**: $LINES_APP" >> STATS.md
        echo "- **Righe templates**: $LINES_HTML" >> STATS.md
        echo "- **File totali**: $TOTAL_FILES" >> STATS.md
        echo "- **Ultimo aggiornamento**: $(date)" >> STATS.md
        
    - name: ğŸ”„ Update Documentation
      run: |
        echo "ğŸ“ Aggiornando documentazione..."
        
        # Aggiorna data nel README se necessario
        if grep -q "Ultima ottimizzazione" README.md; then
          sed -i "s/\*\*Ultima ottimizzazione\*\*: .*/\*\*Ultima ottimizzazione\*\*: $(date +"%B %Y") - Sistema Messaggi Vestiaire v2.0/" README.md
          echo "âœ… Data README aggiornata"
        fi
        
    - name: ğŸ“¤ Commit Changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add -A
        
        if git diff --staged --quiet; then
          echo "âœ… Nessun cambiamento da committare"
        else
          git commit -m "ğŸ¤– AUTO-UPDATE: Documenti e statistiche aggiornate"
          git push
          echo "âœ… Cambiamenti committati e pushati"
        fi
        
    - name: ğŸ¯ Validation Summary
      run: |
        echo "ğŸ¯ RIEPILOGO VALIDAZIONE:"
        echo "================================"
        echo "âœ… Dipendenze verificate"
        echo "âœ… Struttura file controllata"  
        echo "âœ… Statistiche generate"
        echo "âœ… Documentazione aggiornata"
        echo "ğŸš€ Sistema pronto per deploy!" 